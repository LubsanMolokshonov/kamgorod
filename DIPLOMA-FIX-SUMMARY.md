# Исправление функционала скачивания дипломов

## Проблема
При скачивании дипломов отображались статические данные-заполнители из SVG шаблонов вместо реальных данных пользователя.

## Причина
SVG шаблоны содержали жестко закодированный текст (имена, названия организаций, номинации и т.д.), который отображался в PDF поверх или вместо динамического текста.

## Решение

### Этап 1: Очистка SVG шаблонов
Удалили из всех 6 SVG шаблонов текстовые элементы с данными-заполнителями, оставив только:
- Декоративные элементы (рамки, линии, фигуры)
- Статичные заголовки ("ДИПЛОМ", "УЧАСТНИКА", "Настоящий диплом выдан" и т.д.)
- Пустые области для динамического текста

### Этап 2: Конвертация в PNG
Конвертировали очищенные SVG шаблоны в PNG формат высокого разрешения (300 DPI) для использования в качестве фона.

### Этап 3: Обновление системы
- Обновили записи в базе данных для использования PNG файлов
- Исправили класс `Diploma.php` для корректной работы с PNG фоном
- Настроили позиционирование динамического текста

## Выполненные изменения

### 1. Установка инструментов
- Установлен `librsvg2-bin` в Docker контейнер
- Добавлен в `Dockerfile` для автоматической установки

### 2. Файлы шаблонов
**Расположение:** `assets/images/diplomas/templates/`

- `diploma-template-{1-6}.svg` - оригинальные SVG (не используются)
- `diploma-template-{1-6}-clean.svg` - очищенные SVG
- `diploma-template-{1-6}.png` - **используемые PNG шаблоны** (300 DPI)

### 3. Обновления кода

**Файл: `classes/Diploma.php`**
- ✅ Добавлена проверка существования файла шаблона
- ✅ Автоопределение MIME-типа (PNG/JPG/SVG)
- ✅ Исправлено использование `pdf_path` вместо `pdf_filename`
- ✅ Обратная совместимость для названий полей

**Файл: `Dockerfile`**
- ✅ Добавлен пакет `librsvg2-bin` для конвертации SVG

### 4. База данных
**Таблица: `diploma_templates`**
```sql
UPDATE diploma_templates SET
  template_image = 'templates/diploma-template-{N}.png'
WHERE id = {N};
```

## Как это работает сейчас

1. Система загружает данные регистрации (ФИО, организация, номинация и т.д.)
2. Загружает PNG шаблон как фоновое изображение
3. Накладывает динамический текст поверх PNG с помощью mPDF
4. Генерирует итоговый PDF файл

## Данные в дипломе

### Динамические поля (из БД):
- **ФИО участника** - `users.full_name`
- **Организация** - `users.organization`
- **Город** - `users.city`
- **Название конкурса** - `competitions.title`
- **Номинация** - `registrations.nomination`
- **Название работы** - `registrations.work_title`
- **Место** - `registrations.placement`
- **Дата участия** - `registrations.participation_date`

### Статические элементы:
- Заголовок "ДИПЛОМ"
- Подзаголовок "УЧАСТНИКА"
- Текст "Настоящий диплом выдан"
- Текст "за участие в конкурсе"
- Декоративные элементы и рамки

## Команды для повторной генерации шаблонов

Если нужно обновить дизайн шаблонов:

```bash
# 1. Отредактируйте SVG файлы (удалите текст-заполнители)
# 2. Конвертируйте в PNG (300 DPI)

docker-compose exec web bash
for i in {1..6}; do
    rsvg-convert -d 300 -p 300 \
        assets/images/diplomas/templates/diploma-template-${i}-clean.svg \
        -o assets/images/diplomas/templates/diploma-template-${i}.png
done
```

## Тестирование

✅ Диплом генерируется с PNG фоном
✅ Данные пользователя корректно отображаются
✅ Нет статического текста-заполнителя
✅ PDF создается размером ~70-100 KB
✅ Качество подходит для печати (300 DPI)

## Известные вопросы

### Позиционирование текста
Координаты текстовых полей задаются в `diploma_templates.field_positions` (JSON):
```json
{
  "fio": {"x": 297, "y": 120, "size": 24, "align": "center"},
  "org": {"x": 297, "y": 150, "size": 18, "align": "center"},
  "nomination": {"x": 297, "y": 180, "size": 16, "align": "center"}
}
```

**Примечание:** Координаты могут требовать настройки для идеального позиционирования на каждом шаблоне.

---

**Дата последнего обновления:** 25.12.2025
**Статус:** ✅ Полностью исправлено и протестировано
