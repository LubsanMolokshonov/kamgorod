# Фаза 6: Личный кабинет - ЗАВЕРШЕНА ✅

## Что было сделано

### 1. Автологин через Cookie
**Файлы:**
- `pages/cabinet.php` (строки 13-23) - Проверка cookie при входе в кабинет
- `ajax/create-payment.php` (строки 70-85) - Генерация session_token после "оплаты"
- `pages/logout.php` (строки 12-15) - Очистка cookie при выходе

**Как работает:**
1. После "оплаты" генерируется 64-символьный случайный token (32 байта)
2. Token сохраняется в `users.session_token` в БД
3. Token устанавливается в cookie `session_token` со сроком действия 30 дней
4. При заходе в кабинет проверяется cookie, и если токен валиден - пользователь автоматически входит
5. При выходе cookie удаляется

**Безопасность:**
- HttpOnly flag = true (защита от XSS)
- Secure flag = true если используется HTTPS
- Срок действия: 30 дней

### 2. Страница личного кабинета
**Файл:** `pages/cabinet.php`

**Функционал:**
- ✅ Отображение email пользователя
- ✅ Список всех оплаченных регистраций
- ✅ Статусы регистраций с цветовыми бейджами:
  - Желтый (#fbbf24) - "В ожидании" (pending)
  - Зеленый (#10b981) - "Оплачено" (paid)
  - Синий (#3b82f6) - "Диплом выдан" (diploma_ready)
- ✅ Карточки регистраций с информацией:
  - Название конкурса
  - ФИО участника
  - Номинация
  - Дата регистрации
  - Стоимость
- ✅ Кнопки "Скачать диплом" (заблокированы с надписью "Генерация PDF будет в Фазе 7")
- ✅ Кнопки "Предпросмотр" (ссылка на ajax/preview-diploma.php)
- ✅ Сообщение об успешной оплате (если параметр ?payment=success)
- ✅ Пустое состояние если нет регистраций
- ✅ DEBUG блок с информацией о пользователе (временный)

### 3. Страница входа/регистрации
**Файл:** `pages/login.php`

**Функционал:**
- ✅ Единая форма для входа и регистрации
- ✅ Поля: Email, ФИО
- ✅ Автоматическое определение: если email существует - вход, иначе - регистрация
- ✅ Установка сессии после входа
- ✅ Редирект в кабинет после успешного входа
- ✅ Валидация email и обязательных полей
- ✅ Показ ошибок и успешных сообщений

### 4. Выход из системы
**Файл:** `pages/logout.php`

**Функционал:**
- ✅ Очистка cookie session_token
- ✅ Уничтожение сессии
- ✅ Редирект на главную страницу

### 5. Стили
**Файлы:**
- `assets/css/cabinet.css` - Стили для личного кабинета
- `assets/css/login.css` - Стили для страницы входа

**Особенности дизайна:**
- Фиолетовый градиент для заголовков карточек
- Зеленый градиент для сообщения об успешной оплате
- Адаптивная сетка для регистраций (grid, min-width 400px)
- Hover-эффекты на карточках
- Статусные бейджи с цветовой кодировкой
- Отзывчивый дизайн для мобильных устройств

### 6. Навигация
**Файл:** `includes/header.php` (строки 31-36)

**Изменения:**
- ✅ Показывается "Личный кабинет" если пользователь авторизован
- ✅ Показывается "Выйти" если пользователь авторизован
- ✅ Показывается "Войти" если пользователь НЕ авторизован

### 7. Класс DiplomaPreview
**Файл:** `classes/DiplomaPreview.php`

**Функционал:**
- ✅ Загрузка SVG-шаблонов дипломов
- ✅ Замена placeholder-текста на реальные данные пользователя
- ✅ Работа с DOM для манипуляции SVG
- ✅ Усечение длинных текстов (макс. 55 символов)
- ✅ Поддержка всех полей формы:
  - ФИО
  - Организация
  - Город
  - Номинация
  - Название работы
  - Место (1, 2, 3 или "Участие")
  - Название конкурса
  - Тип конкурса (Всероссийский, Международный, и т.д.)
  - Имя руководителя
- ✅ Генерация data:URI для встраивания SVG

### 8. Эндпоинт предпросмотра
**Файл:** `ajax/preview-diploma.php`

**Функционал:**
- ✅ Получение данных формы и ID шаблона
- ✅ Получение названия конкурса из БД
- ✅ Генерация SVG с данными через DiplomaPreview
- ✅ Возврат SVG как data:URI в JSON

## Поток пользователя

1. **Регистрация на конкурс** → Корзина → "Оплата"
2. **После "оплаты":**
   - Генерируется session_token
   - Token сохраняется в БД
   - Устанавливается cookie (30 дней)
   - Статус регистраций меняется на 'paid'
   - Редирект в кабинет с параметром ?payment=success
3. **В личном кабинете:**
   - Показывается сообщение об успешной оплате
   - Отображаются все оплаченные регистрации
   - Доступны кнопки "Предпросмотр" (работают)
   - Кнопки "Скачать диплом" заблокированы (ожидается Фаза 7)
4. **При повторном визите:**
   - Если cookie session_token существует и валиден → автоматический вход
   - Если cookie отсутствует или невалиден → редирект на /pages/login.php
5. **Выход:**
   - Нажатие "Выйти" → cookie удаляется, сессия уничтожается

## Что НЕ реализовано (будет в Фазе 7)

- ❌ Генерация PDF-дипломов (кнопка "Скачать диплом" заблокирована)
- ❌ Эндпоинт /ajax/download-diploma.php (будет создан в Фазе 7)
- ❌ Сохранение сгенерированных PDF в uploads/diplomas/
- ❌ Таблица diplomas для отслеживания сгенерированных файлов
- ❌ Генерация дипломов руководителя (если has_supervisor = 1)
- ❌ Email-уведомления о готовности дипломов

## Технические детали

### Автологин
```php
// В pages/cabinet.php
if (!isset($_SESSION['user_email']) && isset($_COOKIE['session_token'])) {
    $userObj = new User($db);
    $user = $userObj->findBySessionToken($_COOKIE['session_token']);
    if ($user) {
        $_SESSION['user_email'] = $user['email'];
        $_SESSION['user_id'] = $user['id'];
    }
}
```

### Генерация токена
```php
// В ajax/create-payment.php
$userObj = new User($db);
$sessionToken = $userObj->generateSessionToken($userId);

setcookie(
    'session_token',
    $sessionToken,
    time() + (30 * 24 * 60 * 60), // 30 дней
    '/',
    '',
    isset($_SERVER['HTTPS']), // Secure if HTTPS
    true // HttpOnly
);
```

### SQL-запрос для регистраций
```sql
SELECT
    r.id,
    r.nomination,
    r.work_title,
    r.diploma_template_id,
    r.status,
    r.created_at,
    c.title as competition_name,
    c.price,
    u.full_name,
    u.email
FROM registrations r
JOIN competitions c ON r.competition_id = c.id
JOIN users u ON r.user_id = u.id
WHERE u.email = ? AND r.status IN ('paid', 'diploma_ready')
ORDER BY r.created_at DESC
```

## Файлы, измененные в Фазе 6

1. `pages/cabinet.php` - Добавлен автологин через cookie
2. `ajax/create-payment.php` - Добавлена генерация session_token и установка cookie
3. `pages/logout.php` - Добавлено удаление cookie
4. `classes/DiplomaPreview.php` - Уже существовал (не изменялся)
5. `pages/login.php` - Уже существовал (не изменялся)
6. `assets/css/cabinet.css` - Уже существовал (не изменялся)
7. `assets/css/login.css` - Уже существовал (не изменялся)
8. `includes/header.php` - Уже содержал проверку авторизации (не изменялся)

## Тестирование

### Как протестировать Фазу 6:

1. **Регистрация и оплата:**
   ```
   1. Перейти на главную страницу
   2. Выбрать конкурс → Принять участие
   3. Выбрать шаблон диплома и заполнить форму
   4. Добавить в корзину
   5. Нажать "Перейти к оплате"
   6. В кабинете должна появиться регистрация со статусом "Оплачено"
   7. Должно показаться сообщение "Оплата успешно завершена!"
   ```

2. **Автологин:**
   ```
   1. После оплаты закрыть браузер
   2. Открыть браузер заново
   3. Перейти на /pages/cabinet.php
   4. Должен произойти автоматический вход (без редиректа на login.php)
   ```

3. **Выход:**
   ```
   1. Находясь в кабинете, нажать "Выйти"
   2. Должен произойти редирект на главную
   3. При попытке зайти в /pages/cabinet.php должен быть редирект на /pages/login.php
   ```

4. **Вход с существующим email:**
   ```
   1. Перейти на /pages/login.php
   2. Ввести email, который уже зарегистрирован
   3. Ввести ФИО (любое)
   4. Должен произойти вход и редирект в кабинет
   ```

5. **Регистрация нового пользователя:**
   ```
   1. Перейти на /pages/login.php
   2. Ввести новый email
   3. Ввести ФИО
   4. Должна создаться новая запись в users
   5. Должен произойти автоматический вход
   ```

## Следующий шаг: Фаза 7

После завершения Фазы 6, следующим этапом будет **Фаза 7: Генерация PDF-дипломов** с использованием библиотеки mPDF.
