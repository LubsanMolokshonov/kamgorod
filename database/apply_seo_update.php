#!/usr/bin/env php
<?php
/**
 * Быстрое применение SEO-обновлений
 * Этот скрипт автоматически применит миграцию и сгенерирует SEO-контент
 */

echo "\n";
echo "╔════════════════════════════════════════════════════════════════╗\n";
echo "║    SEO-ОБНОВЛЕНИЕ ДЛЯ КОНКУРСОВ                                ║\n";
echo "║    Добавление целей, задач и SEO-описаний                      ║\n";
echo "╚════════════════════════════════════════════════════════════════╝\n";
echo "\n";

require_once __DIR__ . '/../config/database.php';

// Подключаемся к БД
try {
    $pdo = new PDO(
        "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4",
        DB_USER,
        DB_PASS,
        [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
    );
    echo "✓ Подключение к БД успешно\n\n";
} catch (PDOException $e) {
    die("✗ Ошибка подключения: " . $e->getMessage() . "\n");
}

// ШАГ 1: Проверяем, нужна ли миграция
echo "ШАГ 1: Проверка структуры таблицы...\n";

$columnsCheck = $pdo->query("SHOW COLUMNS FROM competitions LIKE 'goals'")->fetchAll();

if (count($columnsCheck) > 0) {
    echo "⚠ Поля уже существуют, пропускаем миграцию\n\n";
} else {
    echo "→ Применяем миграцию базы данных...\n";

    try {
        // Читаем и выполняем миграцию
        $migration = file_get_contents(__DIR__ . '/migrations/006_add_seo_fields.sql');

        // Удаляем комментарии и разбиваем на отдельные запросы
        $statements = array_filter(
            array_map('trim', explode(';', $migration)),
            function($stmt) {
                return !empty($stmt) && strpos($stmt, '--') !== 0;
            }
        );

        foreach ($statements as $statement) {
            if (!empty(trim($statement))) {
                $pdo->exec($statement);
            }
        }

        echo "✓ Миграция применена успешно\n\n";
    } catch (PDOException $e) {
        die("✗ Ошибка применения миграции: " . $e->getMessage() . "\n");
    }
}

// ШАГ 2: Генерация SEO-контента
echo "ШАГ 2: Генерация уникального SEO-контента...\n\n";

/**
 * Генератор целей конкурса
 */
function generateGoals($competition) {
    $category = $competition['category'];
    $goals = [];

    switch ($category) {
        case 'methodology':
            $goals[] = "Выявление и распространение передового педагогического опыта в сфере образования";
            $goals[] = "Стимулирование профессионального роста и творческой активности педагогических работников";
            $goals[] = "Повышение качества образовательного процесса через внедрение инновационных методик";
            $goals[] = "Создание профессионального сообщества для обмена опытом и лучшими практиками";
            break;

        case 'extracurricular':
            $goals[] = "Развитие системы внеурочной деятельности и дополнительного образования";
            $goals[] = "Поддержка творческих инициатив педагогов в организации досуговой деятельности";
            $goals[] = "Формирование банка эффективных методических разработок внеурочных мероприятий";
            $goals[] = "Содействие профессиональному развитию классных руководителей и педагогов-организаторов";
            break;

        case 'creative':
            $goals[] = "Раскрытие творческого потенциала обучающихся и поддержка одаренных детей";
            $goals[] = "Создание условий для самореализации и творческого самовыражения детей";
            $goals[] = "Популяризация различных видов детского творчества";
            $goals[] = "Формирование позитивного образовательного пространства для развития талантов";
            break;

        case 'student_projects':
            $goals[] = "Развитие исследовательских компетенций и проектного мышления у обучающихся";
            $goals[] = "Поддержка научно-исследовательской деятельности школьников и студентов";
            $goals[] = "Выявление и поощрение способных и мотивированных к исследовательской деятельности учащихся";
            $goals[] = "Формирование навыков публичной презентации результатов собственных исследований";
            break;
    }

    return implode("\n", $goals);
}

/**
 * Генератор задач конкурса
 */
function generateObjectives($competition) {
    $category = $competition['category'];
    $objectives = [];

    $objectives[] = "Создать условия для презентации педагогического опыта и методических достижений участников";
    $objectives[] = "Провести экспертную оценку представленных материалов в соответствии с установленными критериями";

    switch ($category) {
        case 'methodology':
            $objectives[] = "Выявить наиболее эффективные педагогические практики и методические приемы";
            $objectives[] = "Способствовать внедрению современных образовательных технологий в учебный процесс";
            $objectives[] = "Обеспечить методическую поддержку педагогов в профессиональном развитии";
            $objectives[] = "Сформировать электронную базу качественных методических разработок";
            $objectives[] = "Повысить мотивацию педагогов к систематизации и обобщению собственного опыта";
            break;

        case 'extracurricular':
            $objectives[] = "Расширить спектр форм и методов организации внеурочной деятельности";
            $objectives[] = "Создать копилку сценариев и разработок для проведения массовых мероприятий";
            $objectives[] = "Укрепить взаимодействие педагогов, родителей и обучающихся";
            $objectives[] = "Популяризировать активные формы воспитательной работы с детьми";
            break;

        case 'creative':
            $objectives[] = "Предоставить площадку для демонстрации творческих достижений обучающихся";
            $objectives[] = "Развивать эстетический вкус и художественные способности детей";
            $objectives[] = "Поощрить оригинальность и нестандартность творческого мышления";
            $objectives[] = "Способствовать формированию уверенности в собственных силах и талантах";
            $objectives[] = "Организовать обмен творческим опытом между участниками";
            break;

        case 'student_projects':
            $objectives[] = "Развивать навыки критического мышления и аналитических способностей";
            $objectives[] = "Обучать методам научного исследования и проектной работы";
            $objectives[] = "Формировать умение работать с информацией из различных источников";
            $objectives[] = "Создавать условия для профориентации и выбора будущей специальности";
            $objectives[] = "Поддерживать связь науки и образования на всех уровнях";
            break;
    }

    $objectives[] = "Наградить победителей и участников дипломами в электронном формате";

    return implode("\n", $objectives);
}

/**
 * Генератор расширенного SEO-описания
 */
function generateSeoDescription($competition) {
    $title = $competition['title'];
    $target = $competition['target_participants'];
    $category = $competition['category'];
    $price = number_format($competition['price'], 0, ',', ' ');

    $categoryNames = [
        'methodology' => 'методических разработок',
        'extracurricular' => 'внеурочной деятельности',
        'creative' => 'творческих работ',
        'student_projects' => 'проектно-исследовательских работ'
    ];

    $categoryName = $categoryNames[$category] ?? 'конкурсных работ';

    $description = [];

    $description[] = "Приглашаем принять участие во Всероссийском конкурсе {$categoryName} «{$title}»! Конкурс проводится в дистанционном формате и открыт для {$target}. Участие в конкурсе — это отличная возможность продемонстрировать свои профессиональные достижения, получить объективную оценку экспертов и пополнить профессиональное портфолио.";

    $description[] = "Наш конкурс отличается простотой участия, оперативностью подведения итогов и доступной стоимостью ({$price} рублей). Все участники получают дипломы в электронном виде сразу после оплаты участия. При оплате двух конкурсов третий предоставляется бесплатно! Дипломы соответствуют требованиям аттестационных комиссий и могут быть использованы при прохождении аттестации педагогических работников.";

    $description[] = "Для участия необходимо зарегистрироваться на сайте, выбрать номинацию, заполнить данные и произвести оплату. Работы оцениваются по следующим критериям: целесообразность материала, оригинальность, полнота и информативность, научная достоверность, стиль изложения, качество оформления, практическое применение и соответствие ФГОС.";

    return implode("\n\n", $description);
}

// Получаем все конкурсы
$stmt = $pdo->query("SELECT * FROM competitions ORDER BY id");
$competitions = $stmt->fetchAll(PDO::FETCH_ASSOC);

echo "Найдено конкурсов: " . count($competitions) . "\n";
echo str_repeat("─", 64) . "\n\n";

$updateStmt = $pdo->prepare("
    UPDATE competitions
    SET goals = :goals,
        objectives = :objectives,
        seo_description = :seo_description
    WHERE id = :id
");

$successCount = 0;
$skippedCount = 0;

foreach ($competitions as $index => $competition) {
    $num = $index + 1;
    echo "[{$num}/" . count($competitions) . "] {$competition['title']}\n";

    // Проверяем, есть ли уже контент
    if (!empty($competition['goals']) && !empty($competition['objectives'])) {
        echo "   ⤷ Пропущено (уже есть контент)\n\n";
        $skippedCount++;
        continue;
    }

    $goals = generateGoals($competition);
    $objectives = generateObjectives($competition);
    $seoDescription = generateSeoDescription($competition);

    try {
        $updateStmt->execute([
            'goals' => $goals,
            'objectives' => $objectives,
            'seo_description' => $seoDescription,
            'id' => $competition['id']
        ]);

        echo "   ✓ Успешно обновлено\n\n";
        $successCount++;

    } catch (PDOException $e) {
        echo "   ✗ Ошибка: " . $e->getMessage() . "\n\n";
    }
}

echo str_repeat("═", 64) . "\n";
echo "\n";
echo "РЕЗУЛЬТАТЫ:\n";
echo "  ✓ Успешно обновлено: {$successCount}\n";
echo "  ⤷ Пропущено: {$skippedCount}\n";
echo "  ∑ Всего конкурсов: " . count($competitions) . "\n";
echo "\n";

if ($successCount > 0) {
    echo "✓ SEO-контент успешно сгенерирован!\n";
    echo "\nТеперь откройте любую страницу конкурса чтобы увидеть:\n";
    echo "  • Цели конкурса (с красивыми иконками)\n";
    echo "  • Задачи конкурса (нумерованный список)\n";
    echo "  • Расширенное SEO-описание\n";
} else {
    echo "ℹ Все конкурсы уже имеют SEO-контент\n";
}

echo "\n";
