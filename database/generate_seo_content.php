<?php
/**
 * SEO Content Generator for Competitions
 * Генерирует уникальные цели, задачи и SEO-описания для каждого конкурса
 */

require_once __DIR__ . '/../config/database.php';

// Подключаемся к БД
try {
    $pdo = new PDO(
        "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4",
        DB_USER,
        DB_PASS,
        [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]
    );
    echo "✓ Подключение к БД успешно\n\n";
} catch (PDOException $e) {
    die("Ошибка подключения: " . $e->getMessage() . "\n");
}

/**
 * Генератор целей конкурса на основе категории и аудитории
 */
function generateGoals($competition) {
    $category = $competition['category'];
    $target = $competition['target_participants'];
    $title = $competition['title'];

    $goals = [];

    // Общие цели в зависимости от категории
    switch ($category) {
        case 'methodology':
            $goals[] = "Выявление и распространение передового педагогического опыта в области {$competition['slug']}";
            $goals[] = "Стимулирование профессионального роста и творческой активности педагогических работников";
            $goals[] = "Повышение качества образовательного процесса через внедрение инновационных методик";
            $goals[] = "Создание профессионального сообщества для обмена опытом и лучшими практиками";
            break;

        case 'extracurricular':
            $goals[] = "Развитие системы внеурочной деятельности и дополнительного образования";
            $goals[] = "Поддержка творческих инициатив педагогов в организации досуговой деятельности";
            $goals[] = "Формирование банка эффективных методических разработок внеурочных мероприятий";
            $goals[] = "Содействие профессиональному развитию классных руководителей и педагогов-организаторов";
            break;

        case 'creative':
            $goals[] = "Раскрытие творческого потенциала обучающихся и поддержка одаренных детей";
            $goals[] = "Создание условий для самореализации и творческого самовыражения детей";
            $goals[] = "Популяризация различных видов детского творчества";
            $goals[] = "Формирование позитивного образовательного пространства для развития талантов";
            break;

        case 'student_projects':
            $goals[] = "Развитие исследовательских компетенций и проектного мышления у обучающихся";
            $goals[] = "Поддержка научно-исследовательской деятельности школьников и студентов";
            $goals[] = "Выявление и поощрение способных и мотивированных к исследовательской деятельности учащихся";
            $goals[] = "Формирование навыков публичной презентации результатов собственных исследований";
            break;
    }

    return implode("\n", $goals);
}

/**
 * Генератор задач конкурса
 */
function generateObjectives($competition) {
    $category = $competition['category'];

    $objectives = [];

    // Общие задачи
    $objectives[] = "Создать условия для презентации педагогического опыта и методических достижений участников";
    $objectives[] = "Провести экспертную оценку представленных материалов в соответствии с установленными критериями";

    // Специфичные задачи в зависимости от категории
    switch ($category) {
        case 'methodology':
            $objectives[] = "Выявить наиболее эффективные педагогические практики и методические приемы";
            $objectives[] = "Способствовать внедрению современных образовательных технологий в учебный процесс";
            $objectives[] = "Обеспечить методическую поддержку педагогов в профессиональном развитии";
            $objectives[] = "Сформировать электронную базу качественных методических разработок для свободного использования";
            $objectives[] = "Повысить мотивацию педагогов к систематизации и обобщению собственного опыта";
            break;

        case 'extracurricular':
            $objectives[] = "Расширить спектр форм и методов организации внеурочной деятельности";
            $objectives[] = "Создать копилку сценариев и разработок для проведения массовых мероприятий";
            $objectives[] = "Укрепить взаимодействие педагогов, родителей и обучающихся через совместную деятельность";
            $objectives[] = "Популяризировать активные формы воспитательной работы с детьми";
            break;

        case 'creative':
            $objectives[] = "Предоставить площадку для демонстрации творческих достижений обучающихся";
            $objectives[] = "Развивать эстетический вкус и художественные способности детей";
            $objectives[] = "Поощрить оригинальность и нестандартность творческого мышления";
            $objectives[] = "Способствовать формированию уверенности в собственных силах и талантах";
            $objectives[] = "Организовать обмен творческим опытом между участниками";
            break;

        case 'student_projects':
            $objectives[] = "Развивать навыки критического мышления и аналитических способностей";
            $objectives[] = "Обучать методам научного исследования и проектной работы";
            $objectives[] = "Формировать умение работать с информацией из различных источников";
            $objectives[] = "Создавать условия для профориентации и выбора будущей специальности";
            $objectives[] = "Поддерживать связь науки и образования на всех уровнях";
            break;
    }

    $objectives[] = "Наградить победителей и участников дипломами в электронном формате";

    return implode("\n", $objectives);
}

/**
 * Генератор расширенного SEO-описания
 */
function generateSeoDescription($competition) {
    $title = $competition['title'];
    $target = $competition['target_participants'];
    $category = $competition['category'];
    $year = $competition['academic_year'];
    $price = number_format($competition['price'], 0, ',', ' ');

    $categoryNames = [
        'methodology' => 'методических разработок',
        'extracurricular' => 'внеурочной деятельности',
        'creative' => 'творческих работ',
        'student_projects' => 'проектно-исследовательских работ'
    ];

    $categoryName = $categoryNames[$category] ?? 'конкурсных работ';

    $description = [];

    // Первый абзац - приглашение
    $description[] = "Приглашаем принять участие во Всероссийском конкурсе {$categoryName} «{$title}»! Конкурс проводится в дистанционном формате и открыт для {$target}. Участие в конкурсе — это отличная возможность продемонстрировать свои профессиональные достижения, получить объективную оценку экспертов и пополнить профессиональное портфолио.";

    // Второй абзац - преимущества
    $description[] = "Наш конкурс отличается простотой участия, оперативностью подведения итогов и доступной стоимостью ({$price} рублей). Все участники получают дипломы в электронном виде сразу после оплаты участия. При оплате двух конкурсов третий предоставляется бесплатно! Дипломы соответствуют требованиям аттестационных комиссий и могут быть использованы при прохождении аттестации педагогических работников.";

    // Третий абзац - процесс участия
    $description[] = "Для участия необходимо зарегистрироваться на сайте, выбрать номинацию, заполнить данные и произвести оплату. Конкурс проводится в течение всего {$year} учебного года. Работы оцениваются по следующим критериям: целесообразность материала, оригинальность, полнота и информативность, научная достоверность, стиль изложения, качество оформления, практическое применение и соответствие ФГОС.";

    return implode("\n\n", $description);
}

// Получаем все конкурсы
$stmt = $pdo->query("SELECT * FROM competitions ORDER BY id");
$competitions = $stmt->fetchAll(PDO::FETCH_ASSOC);

echo "Найдено конкурсов: " . count($competitions) . "\n\n";
echo "Начинаем генерацию SEO-контента...\n";
echo str_repeat("=", 80) . "\n\n";

$updateStmt = $pdo->prepare("
    UPDATE competitions
    SET goals = :goals,
        objectives = :objectives,
        seo_description = :seo_description
    WHERE id = :id
");

$successCount = 0;

foreach ($competitions as $competition) {
    echo "Обработка: {$competition['title']}\n";
    echo "Категория: {$competition['category']}\n";

    $goals = generateGoals($competition);
    $objectives = generateObjectives($competition);
    $seoDescription = generateSeoDescription($competition);

    try {
        $updateStmt->execute([
            'goals' => $goals,
            'objectives' => $objectives,
            'seo_description' => $seoDescription,
            'id' => $competition['id']
        ]);

        echo "✓ Успешно обновлено\n";
        $successCount++;

        // Выводим превью
        echo "\nЦели (первые 150 символов):\n";
        echo substr($goals, 0, 150) . "...\n\n";

    } catch (PDOException $e) {
        echo "✗ Ошибка: " . $e->getMessage() . "\n";
    }

    echo str_repeat("-", 80) . "\n\n";
}

echo str_repeat("=", 80) . "\n";
echo "Генерация завершена!\n";
echo "Успешно обновлено конкурсов: {$successCount} из " . count($competitions) . "\n";
